CXX=icpc  -openmp
CXXFLAGS= -O3 -xavx 

ISPC=ispc
ISPCFLAGS =  -O3 --target=avx1-i32x8 
ISPCFLAGS+= --opt=force-aligned-memory

ARCH=avx
all: $(ARCH)/replace_ispc.s replace_$(ARCH)

replace_$(ARCH): $(ARCH)/replace_ispc.o replace.cpp params.h
	$(CXX) $(CXXFLAGS)  -o $@ $^ -g

$(ARCH)/replace_ispc.o: $(ARCH)/replace_ispc.s
	$(CXX) $(CXXFLAGS) -c -o $@ $<

$(ARCH)/replace_ispc.s: replace.ispc params.h
	mkdir -p $(ARCH)
	if [ -f replace_ispc_avx.s ]; then cp replace_ispc_avx.s $@; else $(ISPC) $(ISPCFLAGS) --emit-asm  -o $@ $<; fi

run_compact: all
	KMP_AFFINITY=compact ./replace_$(ARCH) 1024000 1
	KMP_AFFINITY=compact ./replace_$(ARCH) 1024000 2
	KMP_AFFINITY=compact ./replace_$(ARCH) 1024000 4

run_scatter: all
	KMP_AFFINITY=scatter ./replace_$(ARCH) 1024000 1
	KMP_AFFINITY=scatter ./replace_$(ARCH) 1024000 2
	KMP_AFFINITY=scatter ./replace_$(ARCH) 1024000 4

clean:
	/bin/rm -rf replace_$(ARCH)  $(ARCH)

clean_all:
	/bin/rm -rf replace_$(ARCH) $(ARCH) *~
