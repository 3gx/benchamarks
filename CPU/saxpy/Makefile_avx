CXX=icpc  -openmp
CXXFLAGS= -O3 -xavx -g

ISPC=ispc
ISPCFLAGS =  -O3 --target=avx1-i32x8 
ISPCFLAGS+= --opt=force-aligned-memory

ARCH=avx
all: saxpy_$(ARCH) $(ARCH)/saxpy_ispc.s

saxpy_$(ARCH): $(ARCH)/saxpy_ispc.o saxpy.cpp
	$(CXX) $(CXXFLAGS)  -o $@ $^

$(ARCH)/saxpy_ispc.o: saxpy.ispc
	mkdir -p $(ARCH)
	$(ISPC) $(ISPCFLAGS)  -o $@ $<

$(ARCH)/saxpy_ispc.s: saxpy.ispc
	mkdir -p $(ARCH)
	$(ISPC) $(ISPCFLAGS) --emit-asm  -o $@ $<

run_compact: saxpy_$(ARCH)
	KMP_AFFINITY=compact ./saxpy_$(ARCH) 1024000 2

run_scatter: saxpy_$(ARCH)
	KMP_AFFINITY=scatter ./saxpy_$(ARCH) 1024000 2

clean:
	/bin/rm -rf saxpy_$(ARCH)  $(ARCH)

clean_all:
	/bin/rm -rf saxpy_$(ARCH) $(ARCH) *~
